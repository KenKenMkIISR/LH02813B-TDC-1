REM LH02813B-TDC-1
REM Pin Assign
REM 1  CS --- B8
REM 2  RD --- B9
REM 3  WR --- B10
REM 4  DATA - B11
REM 5  GND
REM 6  VDD (+3.3V)
REM 7  ?
REM 8  LED+ (+3.3V)
REM 9  LED- (GND)
REM 10 NC(?)

REM Video Off
SYSTEM 200,0

GOSUB LHINIT

USEVAR FONT
DIM FONT(15)
RESTORE FONTDT
FOR I=0 TO 15:FONT(I)=READ():NEXT

FOR I=0 TO 16
 GOSUB PUTNUM,16-I,I%16,0
NEXT
GOSUB WRDATA,$24,$0E
GOSUB WRDATA,$0A,$05
GOSUB WRDATA,$0B,$02

WAIT 30
FOR I=0 TO 16
 GOSUB PUTNUM,I,-1,0
NEXT
GOSUB WRDATA,$24,$00
GOSUB WRDATA,$0A,$00
GOSUB WRDATA,$0B,$00

USECLASS RTC
R=NEW(RTC)
S=-1
DO
 CALL R.RD()
 IF R.SEC!=S THEN
  GOSUB PUTTIM,R
  S=R.SEC
 ENDIF
 WAIT 10
LOOP

END

LABEL PUTTIM
 VAR D,T,I
 T=ARGS(1)
 D=T.YEAR+2000
 FOR I=12 TO 15
  GOSUB PUTNUM,I,D%10,0
  D=D/10
 NEXT
 D=T.MONTH
 GOSUB PUTNUM,10,D/10,0
 GOSUB PUTNUM,9,D%10,0
 D=T.DAY
 GOSUB PUTNUM,7,D/10,0
 GOSUB PUTNUM,6,D%10,0
  D=T.HOUR
 GOSUB PUTNUM,5,D/10,0
 GOSUB PUTNUM,4,D%10,1
 D=T.MIN
 GOSUB PUTNUM,3,D/10,0
 GOSUB PUTNUM,2,D%10,1
 D=T.SEC
 GOSUB PUTNUM,1,D/10,0
 GOSUB PUTNUM,0,D%10,0
RETURN

LABEL PUTNUM
 REM PUTNUM,Segment No,Num,CommaFlag
 REM Num<0 means space
 VAR A,D
 A=ARGS(1)
 IF ARGS(2)>=0 THEN D=FONT(ARGS(2)) ELSE D=0
 IF A<5 THEN A=8-A*2 ELSE A=A*2+2
 GOSUB WRDATA,A,D>>4
 IF ARGS(3) THEN D=D OR 1
 GOSUB WRDATA,A+1,D
RETURN

LABEL FONTDT
DATA $EE,$48,$D6,$DA,$78,$BA,$BE,$E8,$FE,$FA
DATA $FC,$3E,$A6,$5E,$B6,$B4

LABEL LHINIT
 VAR I
 OUT 8,1:OUT 9,1:OUT 10,1
 GOSUB WRCOMM,$01:REM SYS EN
 GOSUB WRCOMM,$03:REM LCD ON

 REM Clear All Segment
 OUT 8,0:REM Chip Select
 REM Write Data(Successive)
 GOSUB WR1BIT,1
 GOSUB WR1BIT,0
 GOSUB WR1BIT,1

 FOR I=1 TO 6+37*4
  GOSUB WR1BIT,0
 NEXT
 OUT 8,1:REM Chip Diselect
RETURN

LABEL WRCOMM
 REM Write Command
 REM WRCOMM,COM(8)
 VAR D

 OUT 8,0:REM Chip Select
 GOSUB WR1BIT,1
 GOSUB WR1BIT,0
 GOSUB WR1BIT,0

 D=ARGS(1)
 GOSUB WR1BIT,D AND 128
 GOSUB WR1BIT,D AND 64
 GOSUB WR1BIT,D AND 32
 GOSUB WR1BIT,D AND 16

 GOSUB WR1BIT,D AND 8
 GOSUB WR1BIT,D AND 4
 GOSUB WR1BIT,D AND 2
 GOSUB WR1BIT,D AND 1

 GOSUB WR1BIT,0

 OUT 8,1:REM Chip Diselect
RETURN

LABEL WRDATA
 REM Write Data
 REM WRDATA,ADD(6),DATA(4)
 VAR D

 OUT 8,0:REM Chip Select
 GOSUB WR1BIT,1
 GOSUB WR1BIT,0
 GOSUB WR1BIT,1

 D=ARGS(1)
 GOSUB WR1BIT,D AND 32
 GOSUB WR1BIT,D AND 16
 GOSUB WR1BIT,D AND 8
 GOSUB WR1BIT,D AND 4
 GOSUB WR1BIT,D AND 2
 GOSUB WR1BIT,D AND 1

 D=ARGS(2)
 GOSUB WR1BIT,D AND 8
 GOSUB WR1BIT,D AND 4
 GOSUB WR1BIT,D AND 2
 GOSUB WR1BIT,D AND 1

 OUT 8,1:REM Chip Diselect
RETURN

LABEL WR1BIT
 REM Write 1bit
 VAR I
 OUT 11,ARGS(1)!=0
 FOR I=1 TO 200:NEXT
 OUT 10,0
 FOR I=1 TO 200:NEXT
 OUT 10,1
RETURN
